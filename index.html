<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>WEEKLY PLANNER FOR COUPLES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      /* צבעי בעלים / משפחה */
      --alon-bg: rgba(253, 224, 71, 0.18);
      --alon-text:#92400E;
      --alon-border:#FACC15;

      --kim-bg: rgba(129, 140, 248, 0.18);
      --kim-text:#3730A3;
      --kim-border:#818CF8;

      --fam-bg: rgba(45, 212, 191, 0.18);
      --fam-text:#065F46;
      --fam-border:#5EEAD4;

      --other-bg: rgba(148, 163, 184, 0.18);
      --other-text:#111827;
      --other-border:#94A3B8;

      --bg-page:#F3F4F6;
      --bg-card:#FFFFFF;
      --border-grid:#E5E7EB;
      --border-strong:#D1D5DB;
      --text-main:#111827;
      --text-muted:#6B7280;
      --accent:#1D4ED8;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg-page);
      color:var(--text-main);
    }

    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:16px;
    }

    h1{
      margin:0 0 4px;
      font-size:24px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--accent);
    }

    .subtitle{
      margin:0 0 12px;
      color:var(--text-muted);
      font-size:13px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }

    .legend{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--text-muted);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:5px;
    }

    .dot{
      width:11px;
      height:11px;
      border-radius:999px;
      display:inline-block;
    }

    .btn{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border-strong);
      background:#FFFFFF;
      cursor:pointer;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:active{
      transform:translateY(1px);
    }
    .btn.danger{
      border-color:#FCA5A5;
      color:#B91C1C;
      background:#FEF2F2;
    }

    .status{
      font-size:11px;
      color:var(--text-muted);
    }

    /* אזור הגריד + גלילה נוחה בנייד */
    .grid-scroll{
      margin-top:8px;
      background:var(--bg-card);
      border-radius:16px;
      box-shadow:0 10px 25px rgba(15,23,42,0.08);
      border:1px solid var(--border-grid);
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    .grid{
      min-width:900px;
      display:grid;
      grid-template-columns: 120px repeat(7, minmax(120px,1fr));
      border-collapse:collapse;
    }

    .head{
      position:sticky;
      top:0;
      z-index:3;
      background:#F9FAFB;
      padding:10px 6px;
      text-align:center;
      font-weight:600;
      font-size:13px;
      border-bottom:1px solid var(--border-grid);
      border-left:1px solid var(--border-grid);
    }

    .head:first-child{
      border-top-right-radius:16px;
    }
    .head:last-child{
      border-top-left-radius:16px;
    }

    .rowhead{
      position:sticky;
      left:0;
      z-index:2;
      background:#F9FAFB;
      padding:10px 6px;
      font-weight:500;
      font-size:12px;
      border-bottom:1px solid var(--border-grid);
      border-left:1px solid var(--border-grid);
    }

    .cell{
      min-height:120px;
      padding:6px;
      border-left:1px solid var(--border-grid);
      border-bottom:1px solid var(--border-grid);
      font-size:12px;
    }

    .cell-inner{
      display:flex;
      flex-direction:column;
      gap:4px;
      height:100%;
    }

    /* בחירת לוקח/ת / אוסף/ת */
    .role{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
      margin-bottom:3px;
      font-size:11px;
      color:var(--text-muted);
    }

    .seg{
      display:inline-flex;
      border-radius:999px;
      border:1px solid #CBD5E1;
      overflow:hidden;
      background:#F9FAFB;
    }

    .seg button{
      border:none;
      background:transparent;
      padding:3px 7px;
      cursor:pointer;
      font-size:11px;
      color:var(--text-muted);
      white-space:nowrap;
    }

    .seg button.active-alon{
      background:var(--alon-bg);
      color:var(--alon-text);
    }
    .seg button.active-kim{
      background:var(--kim-bg);
      color:var(--kim-text);
    }
    .seg button.active-other{
      background:var(--other-bg);
      color:var(--other-text);
    }

    /* פריטים */
    .items{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:3px;
    }

    .pill{
      border-radius:10px;
      border:1px solid;
      padding:4px 6px;
      font-size:11px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .pill-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }

    .pill .meta{
      font-size:10px;
      opacity:0.7;
    }

    .pill.alon{
      background:var(--alon-bg);
      color:var(--alon-text);
      border-color:var(--alon-border);
    }
    .pill.kim{
      background:var(--kim-bg);
      color:var(--kim-text);
      border-color:var(--kim-border);
    }
    .pill.fam{
      background:var(--fam-bg);
      color:var(--fam-text);
      border-color:var(--fam-border);
    }
    .pill.other{
      background:var(--other-bg);
      color:var(--other-text);
      border-color:var(--other-border);
    }

    /* כפתור הוספת פריט אחד בכל תא – רק פלוס */
    .add{
      align-self:flex-start;
      margin-top:2px;
      border-radius:999px;
      border:1px dashed #CBD5E1;
      background:#F9FAFB;
      padding:2px 9px;
      font-size:14px;
      cursor:pointer;
      color:var(--text-muted);
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .add:hover{
      background:#E5F3FF;
      border-style:solid;
      border-color:#BFDBFE;
      color:var(--accent);
    }

    .footer{
      margin-top:8px;
      font-size:11px;
      color:var(--text-muted);
      text-align:center;
    }

    dialog{
      border:none;
      border-radius:14px;
      padding:0;
      max-width:360px;
      width:90vw;
    }
    .dlg{
      padding:14px 14px 10px;
    }
    .dlg h3{
      margin:0 0 8px;
      font-size:16px;
    }
    .field{
      display:grid;
      gap:4px;
      margin-bottom:8px;
      font-size:12px;
    }
    .field label{
      font-size:11px;
      color:var(--text-muted);
    }
    .row-fields{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    input, select, textarea{
      font:inherit;
      padding:6px 7px;
      border-radius:8px;
      border:1px solid #D1D5DB;
    }
    textarea{
      resize:vertical;
      min-height:50px;
    }
    .btns{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }
    .btn.sm{
      padding:5px 9px;
      font-size:11px;
    }

    @media (max-width:768px){
      .wrap{
        padding:12px;
      }
      h1{
        font-size:20px;
      }
      .grid{
        min-width:700px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WEEKLY PLANNER FOR COUPLES</h1>
    <p class="subtitle">have a good week ✨</p>

    <div class="topbar">
      <div class="legend">
        <span class="badge">
          <span class="dot" style="background:var(--alon-bg); border:1px solid var(--alon-border);"></span>
          אלון
        </span>
        <span class="badge">
          <span class="dot" style="background:var(--kim-bg); border:1px solid var(--kim-border);"></span>
          קים
        </span>
        <span class="badge">
          <span class="dot" style="background:var(--fam-bg); border:1px solid var(--fam-border);"></span>
          משפחה
        </span>
        <span class="badge">
          <span class="dot" style="background:var(--other-bg); border:1px solid var(--other-border);"></span>
          אחר
        </span>
      </div>

      <div style="display:flex;align-items:center;gap:8px;">
        <span id="syncStatus" class="status">Local only</span>
        <button id="resetWeek" class="btn danger" type="button">Reset week</button>
      </div>
    </div>

    <div class="grid-scroll">
      <div id="grid" class="grid"></div>
    </div>

    <div class="footer">
      בבוקר: מי <b>לוקח/ת לגן</b> (א׳–ה׳). אחה״צ: מי <b>אוסף/ת</b> (א׳–ה׳). הבחירה בלעדית לכל יום.
    </div>
  </div>

  <!-- דיאלוג הוספה / עריכה -->
  <dialog id="dlg">
    <form method="dialog" class="dlg">
      <h3>עריכת פריט</h3>

      <div class="field">
        <label>כותרת</label>
        <input id="title" />
      </div>

      <div class="row-fields">
        <div class="field">
          <label>יום</label>
          <select id="day"></select>
        </div>
        <div class="field">
          <label>חלק ביום</label>
          <select id="slot">
            <option value="0">בוקר</option>
            <option value="1">מהלך היום</option>
            <option value="2">אחה״צ</option>
            <option value="3">ערב</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>שייך ל</label>
        <select id="person">
          <option>אלון</option>
          <option>קים</option>
          <option>משפחה</option>
          <option>אחר</option>
        </select>
      </div>

      <div class="field">
        <label>הערות</label>
        <textarea id="notes"></textarea>
      </div>

      <div class="btns">
        <button class="btn sm danger" id="deleteBtn" type="button">מחיקה</button>
        <button class="btn sm" value="cancel">ביטול</button>
        <button class="btn sm" id="saveBtn" type="button" style="background:var(--accent);color:#fff;border-color:var(--accent);">
          שמירה
        </button>
      </div>
    </form>
  </dialog>

  <!-- Firebase SDKs (אותן גרסאות כמו קודם) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <!-- config.js שלך עם FIREBASE_CFG ו-HOUSEHOLD_ID -->
  <script src="config.js"></script>

  <script>
    const DAYS = ["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];
    const SLOTS = ["בוקר","מהלך היום","אחה״צ","ערב"];
    const LS_KEY = "weekly-planner-sync-local";

    let state = loadLocal() || {
      dropoff:Array(7).fill(null),
      pickup:Array(7).fill(null),
      events:[]
    };
    let events = state.events;

    let saveTimer = null;
    let applyingRemote = false;
    let db = null, docRef = null, unsub = null;
    let householdId = window.HOUSEHOLD_ID || "alon-kim";

    const grid = document.getElementById("grid");
    const resetWeekBtn = document.getElementById("resetWeek");
    const syncStatus = document.getElementById("syncStatus");

    const dlg = document.getElementById("dlg");
    const titleEl = document.getElementById("title");
    const dayEl = document.getElementById("day");
    const slotEl = document.getElementById("slot");
    const personEl = document.getElementById("person");
    const notesEl = document.getElementById("notes");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    let editingId = null;

    function id(){ return Math.random().toString(36).slice(2,9); }

    function saveLocal(){
      localStorage.setItem(LS_KEY, JSON.stringify({ ...state, events }));
    }
    function loadLocal(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)); }
      catch(e){ return null; }
    }

    function renderDaysSelect(){
      dayEl.innerHTML = DAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join("");
    }
    renderDaysSelect();

    function pillClass(p){
      if(p==="אלון") return "alon";
      if(p==="קים")  return "kim";
      if(p==="משפחה") return "fam";
      return "other";
    }

    function cleanupWeekendSpecials(){
      // אין לוקח/אוסף בשישי שבת
      events = events.filter(e=>{
        const weekend = e.day >= 5;
        const isSpecial = (e.slot===0 || e.slot===2) &&
          (e.title.startsWith("לוקח") || e.title.startsWith("אוסף"));
        return !(weekend && isSpecial);
      });
      state.dropoff[5] = state.dropoff[6] = null;
      state.pickup[5]  = state.pickup[6]  = null;
      state.events = events;
    }

    function render(){
      cleanupWeekendSpecials();
      grid.innerHTML = "";

      // שורת כותרות
      grid.append(headCell(""));
      for(let d=0; d<7; d++){
        grid.append(headCell(DAYS[d]));
      }

      // שורות של חלקי היום
      for(let s=0; s<4; s++){
        grid.append(rowHead(SLOTS[s]));
        for(let d=0; d<7; d++){
          const items = events.filter(e=>e.day===d && e.slot===s);
          grid.append(cell(d,s,items));
        }
      }
    }

    function headCell(text){
      const div = document.createElement("div");
      div.className = "head";
      div.textContent = text;
      return div;
    }

    function rowHead(text){
      const div = document.createElement("div");
      div.className = "rowhead";
      div.textContent = text;
      return div;
    }

    function makeExclusiveSeg(current, onChange){
      const seg = document.createElement("div");
      seg.className = "seg";
      const options = ["אלון","קים","סבתא"];
      const btns = [];

      options.forEach(opt=>{
        const b = document.createElement("button");
        b.type = "button";
        b.textContent = opt;
        seg.appendChild(b);
        btns.push(b);
      });

      function paint(val){
        btns.forEach((b,i)=>{
          const who = options[i];
          b.className = "";
          if(val === who){
            if(who==="אלון") b.classList.add("active-alon");
            else if(who==="קים") b.classList.add("active-kim");
            else b.classList.add("active-other");
          }
        });
      }

      btns.forEach((b,i)=>{
        b.addEventListener("click", ()=>{
          const who = options[i];
          const next = (current === who) ? null : who;
          current = next;
          paint(current);
          onChange(current);
        });
      });

      paint(current);
      return seg;
    }

    function upsertSpecialEvent(day, slot, label, who){
      // הסר קודם כל אירוע מיוחד קיים
      events = events.filter(e => !(e.day===day && e.slot===slot &&
        (e.title.startsWith("לוקח") || e.title.startsWith("אוסף"))));

      if(who){
        const person = (who === "סבתא") ? "אחר" : who;
        events.push({
          id: id(),
          day,
          slot,
          title: label,
          person,
          notes:""
        });
      }
      state.events = events;
      scheduleSave();
    }

    function cell(day, slot, items){
      const div = document.createElement("div");
      div.className = "cell";

      const inner = document.createElement("div");
      inner.className = "cell-inner";

      // לוקח / אוסף רק א׳–ה׳, בוקר / אחה"צ
      if(day < 5 && (slot === 0 || slot === 2)){
        const role = document.createElement("div");
        role.className = "role";
        const label = document.createElement("span");
        label.textContent = slot===0 ? "לוקח/ת לגן:" : "אוסף/ת:";

        const current = (slot===0 ? state.dropoff[day] : state.pickup[day]) || null;
        const seg = makeExclusiveSeg(current, (val)=>{
          if(slot===0){
            state.dropoff[day] = val;
            upsertSpecialEvent(day,0,"לוקח/ת לגן",val);
          } else {
            state.pickup[day] = val;
            upsertSpecialEvent(day,2,"אוסף/ת",val);
          }
          render();
        });

        role.appendChild(label);
        role.appendChild(seg);
        inner.appendChild(role);
      }

      const itemsContainer = document.createElement("div");
      itemsContainer.className = "items";

      items.forEach(item=>{
        const pill = pillNode(item);
        itemsContainer.appendChild(pill);
      });

      inner.appendChild(itemsContainer);

      // כפתור + יחיד בכל תא
      const add = document.createElement("button");
      add.type = "button";
      add.className = "add";
      add.textContent = "+";
      add.addEventListener("click", ()=>{
        openEditor({
          id:null,
          title:"",
          day,
          slot,
          person:"אלון",
          notes:""
        });
      });
      inner.appendChild(add);

      div.appendChild(inner);
      return div;
    }

    function pillNode(item){
      const p = document.createElement("div");
      p.className = "pill " + pillClass(item.person);

      const t = document.createElement("div");
      t.className = "pill-title";
      const titleSpan = document.createElement("span");
      titleSpan.textContent = item.title;
      const whoSpan = document.createElement("span");
      whoSpan.className = "meta";
      whoSpan.textContent = item.person;
      t.appendChild(titleSpan);
      t.appendChild(whoSpan);
      p.appendChild(t);

      if(item.notes){
        const notesDiv = document.createElement("div");
        notesDiv.className = "meta";
        notesDiv.textContent = item.notes;
        p.appendChild(notesDiv);
      }

      p.addEventListener("click", ()=>{
        openEditor(item);
      });

      return p;
    }

    function openEditor(item){
      editingId = item.id;
      titleEl.value = item.title || "";
      dayEl.value = item.day;
      slotEl.value = item.slot;
      personEl.value = item.person || "אלון";
      notesEl.value = item.notes || "";
      deleteBtn.style.display = editingId ? "inline-block" : "none";
      dlg.showModal();
    }

    saveBtn.addEventListener("click", ()=>{
      const obj = {
        id: editingId || id(),
        title: titleEl.value.trim(),
        day: Number(dayEl.value),
        slot: Number(slotEl.value),
        person: personEl.value,
        notes: notesEl.value.trim()
      };
      if(!obj.title){
        dlg.close();
        return;
      }
      const idx = events.findIndex(e=>e.id===obj.id);
      if(idx >= 0) events[idx] = obj;
      else events.push(obj);
      state.events = events;
      scheduleSave();
      render();
      dlg.close();
    });

    deleteBtn.addEventListener("click", ()=>{
      if(!editingId) return;
      events = events.filter(e=>e.id !== editingId);
      state.events = events;
      scheduleSave();
      render();
      dlg.close();
    });

    resetWeekBtn.addEventListener("click", ()=>{
      if(!confirm("לאפס את השבוע? כל המשימות + לוקח/ת / אוסף/ת יימחקו.")) return;
      state.dropoff = Array(7).fill(null);
      state.pickup  = Array(7).fill(null);
      events = [];
      state.events = events;
      scheduleSave();
      render();
    });

    /* Firebase – שימוש ב-FIREBASE_CFG ו-HOUSEHOLD_ID מקובץ config.js */
    function initFirebase(){
      try{
        const cfg = window.FIREBASE_CFG;
        if(!cfg || !cfg.apiKey){
          syncStatus.textContent = "Local only (no Firebase)";
          render();
          return;
        }
        const app = firebase.initializeApp(cfg);
        const auth = firebase.auth();
        db = firebase.firestore();
        syncStatus.textContent = "Connecting…";
        auth.signInAnonymously()
          .then(()=>{
            syncStatus.textContent = "Connected";
            initRealtime();
          })
          .catch(err=>{
            console.error(err);
            syncStatus.textContent = "Firebase error";
            render();
          });
      } catch(err){
        console.error(err);
        syncStatus.textContent = "Config error";
        render();
      }
    }

    function initRealtime(){
      if(!db) { render(); return; }
      if(unsub) unsub();
      docRef = db.collection("plans").doc(householdId);
      docRef.get().then(snap=>{
        if(!snap.exists){
          docRef.set({
            ...state,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      });
      unsub = docRef.onSnapshot(doc=>{
        if(!doc.exists) return;
        applyingRemote = true;
        const data = doc.data();
        state = {
          dropoff: data.dropoff || Array(7).fill(null),
          pickup:  data.pickup  || Array(7).fill(null),
          events:  data.events  || []
        };
        events = state.events;
        saveLocal();
        render();
        applyingRemote = false;
        syncStatus.textContent = "Synced (" + householdId + ")";
      });
    }

    function scheduleSave(){
      saveLocal();
      if(!db || !docRef || applyingRemote) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        docRef.set({
          ...state,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        syncStatus.textContent = "Saving…";
      }, 250);
    }

    // התחלה
    render();
    initFirebase();

    // PWA service worker (אם יש service-worker.js ו־manifest)
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>{
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      });
    }
  </script>
</body>
</html>
