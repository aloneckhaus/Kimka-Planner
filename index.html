<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>WEEKLY PLANNER FOR COUPLES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      /* צבעי בעלים */
      --alon-bg: rgba(253, 224, 71, 0.16);
      --alon-text:#854d0e;
      --alon-border:#facc15;

      --kim-bg: rgba(129, 140, 248, 0.16);
      --kim-text:#3730a3;
      --kim-border:#818cf8;

      --fam-bg: rgba(45, 212, 191, 0.16);
      --fam-text:#065f46;
      --fam-border:#5eead4;

      --other-bg: rgba(148, 163, 184, 0.16);
      --other-text:#111827;
      --other-border:#94a3b8;

      --grid-border:#E5E7EB;
      --bg-main:#EEF2FF;   /* בהיר בסגול/כחול, סטייל גוגל קלנדר */
      --bg-main-2:#E0F2FE;
      --bg-card:#FFFFFF;
      --text-main:#111827;
      --text-muted:#6B7280;
      --accent:#2563EB;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(circle at top left, var(--bg-main) 0, transparent 60%),
        radial-gradient(circle at bottom right, var(--bg-main-2) 0, transparent 55%),
        #F3F4F6;
      color:var(--text-main);
    }

    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:16px;
    }

    h1{
      margin:0 0 4px;
      font-size:24px;
      font-weight:700;
      letter-spacing:0.04em;
    }

    .subtitle{
      margin:0 0 12px;
      color:var(--text-muted);
      font-size:13px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:12px;
    }

    .sync-badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      color:#4b5563;
      background:rgba(255,255,255,0.8);
      backdrop-filter:blur(8px);
    }

    .grid-shell{
      background:linear-gradient(90deg, rgba(37,99,235,0.12), rgba(56,189,248,0.1));
      padding:6px;
      border-radius:18px;
      box-shadow:0 18px 40px rgba(15,23,42,0.18);
    }

    .grid-wrapper{
      background:var(--bg-card);
      border-radius:14px;
      padding:8px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    .grid{
      min-width:720px;
      display:grid;
      grid-template-columns:120px repeat(7, minmax(110px,1fr));
      border:1px solid var(--grid-border);
      border-radius:10px;
      overflow:hidden;
    }

    .cell{
      min-height:120px;
      border-top:1px solid var(--grid-border);
      border-left:1px solid var(--grid-border);
      padding:6px;
      background:#fff;
    }

    .head{
      position:sticky;
      top:0;
      background:#F9FAFB;
      z-index:3;
      border-bottom:1px solid var(--grid-border);
      border-left:1px solid var(--grid-border);
      text-align:center;
      font-weight:600;
      padding:8px 4px;
      font-size:13px;
      color:#111827;
    }

    .head:first-child{
      border-left:none;
    }

    .rowhead{
      position:sticky;
      left:0;
      background:#F9FAFB;
      z-index:2;
      border-right:1px solid var(--grid-border);
      font-weight:600;
      padding:8px;
      font-size:13px;
      color:#111827;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
    }

    .slot-tag{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#E5E7EB;
      color:#374151;
    }

    .pill{
      border:1px solid;
      border-radius:10px;
      padding:4px 6px;
      margin-bottom:4px;
      font-size:12px;
      cursor:pointer;
      transition:background 0.12s ease, transform 0.08s ease;
    }

    .pill:hover{
      transform:translateY(-1px);
    }

    .pill .meta{
      opacity:.8;
      font-size:11px;
    }

    .alon{ background:var(--alon-bg); color:var(--alon-text); border-color:var(--alon-border); }
    .kim{ background:var(--kim-bg); color:var(--kim-text); border-color:var(--kim-border); }
    .fam{ background:var(--fam-bg); color:var(--fam-text); border-color:var(--fam-border); }
    .other{ background:var(--other-bg); color:var(--other-text); border-color:var(--other-border); }

    .role{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      margin-bottom:4px;
    }

    .role label{
      font-size:11px;
      color:#4B5563;
    }

    .seg{
      display:inline-flex;
      border:1px solid #CBD5E1;
      border-radius:999px;
      overflow:hidden;
      background:#F9FAFB;
    }

    .seg button{
      padding:3px 8px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:11px;
      color:#4B5563;
      white-space:nowrap;
    }

    .seg button.active.alon{ background:rgba(253,224,71,0.45); color:#854d0e; }
    .seg button.active.kim{ background:rgba(129,140,248,0.45); color:#3730a3; }
    .seg button.active.other{ background:rgba(148,163,184,0.4); color:#111827; }

    .events-stack{
      margin-top:2px;
      margin-bottom:4px;
    }

    .add-one{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px dashed #CBD5E1;
      background:#F9FAFB;
      color:#4B5563;
      font-size:16px;
      line-height:1;
      cursor:pointer;
      padding:0;
      transition:background 0.12s ease, transform 0.08s ease;
    }

    .add-one:hover{
      background:#E5F0FF;
      transform:translateY(-1px);
    }

    .footer{
      color:#6B7280;
      font-size:11px;
      text-align:left;
      margin-top:8px;
    }

    dialog{
      border:none;
      border-radius:14px;
      padding:0;
      max-width:360px;
      width:90vw;
    }

    .dlg{
      padding:14px 16px 10px;
    }

    .dlg h3{
      margin:0 0 8px;
      font-size:16px;
    }

    input,select,textarea,button{
      font:inherit;
    }

    .field{
      display:grid;
      gap:4px;
      margin-bottom:8px;
      font-size:13px;
    }

    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }

    .btns{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-top:8px;
    }

    .btn{
      padding:7px 12px;
      border-radius:10px;
      border:1px solid #CBD5E1;
      background:#F9FAFB;
      cursor:pointer;
      font-size:13px;
    }

    .btn.primary{
      background:#2563EB;
      color:white;
      border-color:#2563EB;
    }

    .btn.danger{
      background:#FEE2E2;
      border-color:#FECACA;
      color:#B91C1C;
    }

    @media (max-width:768px){
      .wrap{ padding:10px; }
      h1{ font-size:20px; }
      .grid-shell{ padding:4px; }
      .grid-wrapper{ padding:4px; }
      .grid{ min-width:640px; }
      .head{ font-size:12px; }
      .rowhead{ font-size:12px; }
      .cell{ min-height:100px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WEEKLY PLANNER FOR COUPLES</h1>
    <p class="subtitle">have a good week</p>

    <div class="topbar">
      <span style="font-size:12px; color:#4B5563;">
        בוקר / יום / אחה״צ / ערב · Drop-off & Pick-up לתיאו
      </span>
      <span id="syncStatus" class="sync-badge">Local only</span>
    </div>

    <div class="grid-shell">
      <div class="grid-wrapper">
        <div id="grid" class="grid"></div>
      </div>
    </div>

    <p class="footer">
      בוקר (א׳–ה׳): מי לוקח לגן · אחה״צ (א׳–ה׳): מי אוסף. לכל משבצת אפשר להוסיף כמה פריטים, עם בחירה למי זה שייך בחלון העריכה.
    </p>
  </div>

  <dialog id="dlg">
    <form method="dialog" class="dlg">
      <h3>עריכת פריט</h3>
      <div class="field">
        <label>כותרת</label>
        <input id="title" />
      </div>

      <div class="row2">
        <div class="field">
          <label>יום</label>
          <select id="day"></select>
        </div>
        <div class="field">
          <label>חלק ביום</label>
          <select id="slot">
            <option value="0">בוקר</option>
            <option value="1">מהלך היום</option>
            <option value="2">אחה״צ</option>
            <option value="3">ערב</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>שייך ל</label>
        <select id="person">
          <option>אלון</option>
          <option>קים</option>
          <option>משפחה</option>
          <option>אחר</option>
        </select>
      </div>

      <div class="field">
        <label>הערות</label>
        <textarea id="notes" rows="3"></textarea>
      </div>

      <div class="toolbar">
  <div class="legend">
    ...
  </div>
  <button id="resetWeek" class="btn danger">איפוס שבוע</button>
  <button id="gcalSync" class="btn">Google Calendar</button>
  <button id="export" class="btn">ייצוא JSON</button>
  <input id="importFile" type="file" accept="application/json" class="btn" title="ייבוא JSON" />
</div>
 
      <div class="btns">
        <button class="btn danger" id="deleteBtn" type="button">מחיקה</button>
        <div style="flex:1"></div>
        <button class="btn" value="cancel">ביטול</button>
        <button class="btn primary" id="saveBtn" type="button">שמירה</button>
      </div>
    </form>
  </dialog>

  <!-- Firebase compat SDKs + קונפיג חיצוני -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="config.js"></script>

  <script>
    const DAYS = ["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];
    const SLOTS = ["בוקר","מהלך היום","אחה״צ","ערב"];
    const LS_KEY = "weekly-planner-sync-local";
    const gcalSyncBtn = document.getElementById("gcalSync");
    // --- Google Calendar / ICS helpers --- //
function pad(n) {
  return n < 10 ? "0" + n : "" + n;
}

function formatICSDate(d) {
  // תאריך בפורמט YYYYMMDDTHHMMSS (ללא Z, יחשב כ"זמן מקומי")
  return (
    d.getFullYear().toString() +
    pad(d.getMonth() + 1) +
    pad(d.getDate()) +
    "T" +
    pad(d.getHours()) +
    pad(d.getMinutes()) +
    "00"
  );
}

function downloadICS(filename, text) {
  const blob = new Blob([text], { type: "text/calendar;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}



    // --- מצב כללי ---
    let state = null;
    let events = [];
    let db = null;
    let docRef = null;
    let unsub = null;
    let applyingRemote = false;
    let saveTimer = null;
    let householdId = window.HOUSEHOLD_ID || "alon-kim";

    // --- DOM ---
    const grid = document.getElementById("grid");
    const dlg = document.getElementById("dlg");
    const titleEl = document.getElementById("title");
    const dayEl = document.getElementById("day");
    const slotEl = document.getElementById("slot");
    const personEl = document.getElementById("person");
    const notesEl = document.getElementById("notes");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const syncStatus = document.getElementById("syncStatus");

    // --- עזרות מצב ---
    function loadLocal(){
      try{
        return JSON.parse(localStorage.getItem(LS_KEY));
      }catch(e){
        return null;
      }
    }

    function saveLocal(){
      localStorage.setItem(LS_KEY, JSON.stringify({ ...state, events }));
    }

    function initState(){
      const saved = loadLocal();
      if(saved){
        state = {
          dropoff: Array.isArray(saved.dropoff) && saved.dropoff.length===7 ? saved.dropoff : Array(7).fill(null),
          pickup:  Array.isArray(saved.pickup)  && saved.pickup.length===7  ? saved.pickup  : Array(7).fill(null),
          events:  Array.isArray(saved.events)  ? saved.events : []
        };
      }else{
        state = {
          dropoff:Array(7).fill(null),
          pickup:Array(7).fill(null),
          events:[]
        };
      }
      events = state.events;
    }

    initState();

    function id(){
      return Math.random().toString(36).slice(2,9);
    }

    function pillClass(person){
      if(person==="אלון") return "alon";
      if(person==="קים") return "kim";
      if(person==="משפחה") return "fam";
      return "other";
    }

    // מנקה אירועי dropoff/pickup מסופ"ש
    function cleanupWeekendSpecials(){
      events = events.filter(e=>{
        const isWeekend = e.day >= 5;
        const isSpecial = (e.slot===0 || e.slot===2) &&
          (e.title.startsWith("לוקח") || e.title.startsWith("אוסף"));
        return !(isWeekend && isSpecial);
      });
      state.dropoff[5] = null;
      state.dropoff[6] = null;
      state.pickup[5] = null;
      state.pickup[6] = null;
      state.events = events;
    }

    // --- UI ---
    function cellHead(text){
      const div = document.createElement("div");
      div.className = "head";
      div.textContent = text;
      return div;
    }

    function rowHead(text){
      const div = document.createElement("div");
      div.className = "rowhead";
      const span = document.createElement("span");
      span.textContent = text;
      const tag = document.createElement("span");
      tag.className = "slot-tag";
      tag.textContent = "•";
      div.append(span, tag);
      return div;
    }

    function makeExclusiveSeg(current, onChange){
      const seg = document.createElement("div");
      seg.className = "seg";
      const options = ["אלון","קים","סבתא"];
      const btns = options.map(name=>{
        const b = document.createElement("button");
        b.type = "button";
        b.textContent = name;
        seg.appendChild(b);
        return b;
      });

      function paint(val){
        btns.forEach((b,i)=>{
          const who = options[i];
          if(val === who){
            b.className = "active " + (who==="אלון"?"alon":who==="קים"?"kim":"other");
          }else{
            b.className = "";
          }
        });
      }

      btns.forEach((b,i)=>{
        b.onclick = ()=>{
          const who = options[i];
          const next = (current===who) ? null : who;
          current = next;
          paint(current);
          onChange(current);
        };
      });

      paint(current);
      return seg;
    }

    function upsertSpecialEvent(day, slot, label, who){
      // מוחק אירוע מיוחד קודם באותו תא
      events = events.filter(e=>!(
        e.day===day &&
        e.slot===slot &&
        (e.title.startsWith("לוקח") || e.title.startsWith("אוסף"))
      ));

      if(who){
        const person = (who==="סבתא") ? "אחר" : who;
        events.push({
          id:id(),
          day,
          slot,
          title:label,
          person,
          notes:""
        });
      }

      state.events = events;
      scheduleSave();
    }

    function pillNode(item){
      const p = document.createElement("div");
      p.className = "pill " + pillClass(item.person);
      p.innerHTML =
        '<div><strong>' + item.title + '</strong> ' +
        '<span class="meta">• ' + item.person + '</span></div>' +
        (item.notes ? '<div class="meta">' + item.notes + '</div>' : '');
      p.addEventListener("click", ()=> openEditor(item));
      return p;
    }

    function addBtn(day, slot){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "add-one";
      btn.textContent = "+";
      btn.addEventListener("click", ()=>{
        openEditor({
          id:null,
          day,
          slot,
          title:"",
          person:"אלון",
          notes:""
        });
      });
      return btn;
    }

    function cell(day, slot, items){
      const div = document.createElement("div");
      div.className = "cell";

      // פס בחירה מי לוקח / אוסף (בוקר / אחה"צ, א׳–ה׳ בלבד)
      if((slot===0 || slot===2) && day < 5){
        const role = document.createElement("div");
        role.className = "role";

        const label = document.createElement("label");
        label.textContent = (slot===0 ? "לוקח/ת לגן:" : "אוסף/ת:");

        const cur = (slot===0 ? state.dropoff[day] : state.pickup[day]);
        const seg = makeExclusiveSeg(cur, val=>{
          if(slot===0){
            state.dropoff[day] = val;
            upsertSpecialEvent(day, 0, "לוקח/ת לגן", val);
          }else{
            state.pickup[day] = val;
            upsertSpecialEvent(day, 2, "אוסף/ת", val);
          }
          render();
        });

        role.append(label, seg);
        div.appendChild(role);
      }

      const stack = document.createElement("div");
      stack.className = "events-stack";
      items.forEach(item=>{
        stack.appendChild(pillNode(item));
      });
      div.appendChild(stack);

      div.appendChild(addBtn(day, slot));

      return div;
    }

    function renderDaySelect(){
      dayEl.innerHTML = DAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join("");
    }

    function render(){
      cleanupWeekendSpecials();
      grid.innerHTML = "";

      // שורת כותרת ימים
      grid.appendChild(cellHead(""));
      for(let d=0; d<7; d++){
        grid.appendChild(cellHead(DAYS[d]));
      }

      // שורות לפי חלקי היום
      for(let s=0; s<4; s++){
        grid.appendChild(rowHead(SLOTS[s]));
        for(let d=0; d<7; d++){
          const items = events.filter(e=>e.day===d && e.slot===s);
          grid.appendChild(cell(d, s, items));
        }
      }
    }

    // --- דיאלוג עריכה ---
    let editingId = null;

    function openEditor(item){
      editingId = item.id;
      titleEl.value = item.title || "";
      dayEl.value = item.day;
      slotEl.value = item.slot;
      personEl.value = item.person || "אלון";
      notesEl.value = item.notes || "";
      deleteBtn.style.display = editingId ? "inline-block" : "none";
      dlg.showModal();
    }

    saveBtn.addEventListener("click", ()=>{
      const obj = {
        id: editingId || id(),
        title: titleEl.value.trim(),
        day: Number(dayEl.value),
        slot: Number(slotEl.value),
        person: personEl.value,
        notes: notesEl.value.trim()
      };
      if(!obj.title){
        dlg.close();
        return;
      }
      const idx = events.findIndex(e=>e.id===obj.id);
      if(idx>=0){
        events[idx] = obj;
      }else{
        events.push(obj);
      }
      state.events = events;
      scheduleSave();
      render();
      dlg.close();
    });

    deleteBtn.addEventListener("click", ()=>{
      if(!editingId) return;
      events = events.filter(e=>e.id !== editingId);
      state.events = events;
      scheduleSave();
      render();
      dlg.close();
    });

    // --- Firebase – שימוש ב-FIREBASE_CFG ו-HOUSEHOLD_ID מקובץ config.js ---
    function initFirebase(){
      try{
        const cfg = window.FIREBASE_CFG;
        if(!cfg || !cfg.apiKey){
          syncStatus.textContent = "Local only (no Firebase)";
          render();
          return;
        }
        const app = firebase.initializeApp(cfg);
        const auth = firebase.auth();
        db = firebase.firestore();
        syncStatus.textContent = "Connecting…";
        auth.signInAnonymously()
          .then(()=>{
            syncStatus.textContent = "Connected";
            initRealtime();
          })
          .catch(err=>{
            console.error(err);
            syncStatus.textContent = "Firebase error";
            render();
          });
      } catch(err){
        console.error(err);
        syncStatus.textContent = "Config error";
        render();
      }
    }

    function initRealtime(){
      if(!db){
        render();
        return;
      }
      if(unsub) unsub();

      docRef = db.collection("plans").doc(householdId);

      // אם המסמך לא קיים – יוצר אחד ראשון
      docRef.get().then(snap=>{
        if(!snap.exists){
          docRef.set({
            ...state,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      });

      unsub = docRef.onSnapshot(doc=>{
        if(!doc.exists) return;
        applyingRemote = true;
        const data = doc.data();
        state = {
          dropoff: Array.isArray(data.dropoff) && data.dropoff.length===7 ? data.dropoff : Array(7).fill(null),
          pickup:  Array.isArray(data.pickup)  && data.pickup.length===7  ? data.pickup  : Array(7).fill(null),
          events:  Array.isArray(data.events)  ? data.events : []
        };
        events = state.events;
        saveLocal();
        render();
        applyingRemote = false;
        syncStatus.textContent = "Synced (" + householdId + ")";
      });
    }

    function scheduleSave(){
      saveLocal();
      if(!db || !docRef || applyingRemote) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        docRef.set({
          ...state,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        syncStatus.textContent = "Saving…";
      }, 250);
    }

    // התחלה
    renderDaySelect();
    render();
    initFirebase();
      render();
  initFirebase();

  // >>> כאן <<< להוסיף את ה-handler של Sync to Google Calendar

  if("serviceWorker" in navigator){
    ...
  }
</script>
</body>
</html>


    // PWA service worker (אם יש service-worker.js ו־manifest)
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>{
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      });
    }
  </script>
</body>
</html>
