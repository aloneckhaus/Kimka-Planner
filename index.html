<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>WEEKLY PLANNER FOR COUPLES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      /* ×¦×‘×¢×™ ×‘×¢×œ×™× */
      --alon-bg: rgba(253, 224, 71, 0.18);
      --alon-text:#facc15;
      --alon-border:#facc15;

      --kim-bg: rgba(129, 140, 248, 0.18);
      --kim-text:#818cf8;
      --kim-border:#818cf8;

      --fam-bg: rgba(45, 212, 191, 0.18);
      --fam-text:#5eead4;
      --fam-border:#5eead4;

      --other-bg: rgba(148, 163, 184, 0.18);
      --other-text:#e5e7eb;
      --other-border:#94a3b8;

      --grid-border:#1f2937;
      --bg-main:#020617;
      --bg-panel:#020617;
      --bg-surface:#020617;
      --bg-header:#020617;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;
      --accent:#38bdf8;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text-main);
      background:
        radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
    }

    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:16px;
    }

    h1{
      margin:0 0 4px;
      font-size:24px;
      display:flex;
      align-items:center;
      gap:8px;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }

    h1 span.mark{
      padding:2px 10px;
      border-radius:999px;
      background:rgba(56,189,248,0.18);
      border:1px solid rgba(56,189,248,0.6);
      font-size:11px;
      text-transform:none;
      color:var(--accent);
    }

    .subtitle{
      margin:0 0 12px;
      color:var(--text-muted);
      font-size:13px;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:10px;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      font-size:11px;
      color:var(--text-muted);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .dot{
      width:10px;
      height:10px;
      border-radius:3px;
      background:#fff3;
    }

    .dot.alon{ background:var(--alon-border); }
    .dot.kim { background:var(--kim-border); }
    .dot.fam { background:var(--fam-border); }
    .dot.other { background:var(--other-border); }

    .admin-toggle{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.8);
      color:var(--text-muted);
      font-size:11px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .admin-toggle:hover{
      border-color:var(--accent);
      color:var(--accent);
    }

    .admin-panel{
      margin-bottom:8px;
      padding:10px 12px;
      border-radius:10px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(30,64,175,0.7);
      display:none;
      font-size:12px;
      color:var(--text-muted);
    }

    .admin-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }

    .btn{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.9);
      color:var(--text-main);
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{ border-color:var(--accent); }

    .btn.danger{
      border-color:#f97373;
      color:#fecaca;
    }
    .btn.danger:hover{
      background:rgba(127,29,29,0.6);
    }

    /* ====== GRID ====== */
    .grid{
      display:grid;
      grid-template-columns: 110px repeat(7, minmax(130px,1fr));
      background:rgba(15,23,42,0.9);
      border-radius:18px;
      overflow:hidden;
      border:1px solid #111827;
      box-shadow:0 18px 45px rgba(0,0,0,0.55);
    }

    .head{
      position:sticky;
      top:0;
      z-index:4;
      background:linear-gradient(to bottom, #020617, #020617ee);
      border-bottom:1px solid var(--grid-border);
      text-align:center;
      font-size:12px;
      font-weight:600;
      padding:10px 6px;
      color:var(--text-muted);
    }

    .head span.day-label{
      display:block;
      color:var(--text-main);
      font-size:13px;
      margin-bottom:2px;
    }

    .head span.date-label{
      font-size:11px;
      opacity:0.6;
    }

    .rowhead{
      position:sticky;
      left:0;
      z-index:3;
      background:linear-gradient(to right,#020617,#020617e6);
      border-inline-end:1px solid var(--grid-border);
      border-bottom:1px solid var(--grid-border);
      padding:12px 10px;
      font-size:12px;
      color:var(--text-muted);
      display:flex;
      align-items:center;
    }

    .cell{
      min-height:120px;
      border-bottom:1px solid var(--grid-border);
      border-inline-start:1px solid var(--grid-border); /* ×§×• ×× ×›×™ ×‘×™×Ÿ ×™××™× */
      padding:6px;
      background:rgba(2,6,23,0.97);
    }

    .cell-inner{
      height:100%;
      border-radius:10px;
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .cell.muted .cell-inner{
      opacity:0.7;
    }

    /* ×—×œ×•×§×” ××œ×•×Ÿ / ×§×™× */
    .dual{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:4px;
      align-items:flex-start;
    }

    .col{
      min-height:60px;
    }

    .col-label{
      font-size:10px;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:4px;
      margin-bottom:2px;
      text-transform:uppercase;
      letter-spacing:0.06em;
    }

    .col-label .mini-dot{
      width:7px;
      height:7px;
      border-radius:3px;
      background:var(--accent);
    }
    .mini-dot.alon{ background:var(--alon-border); }
    .mini-dot.kim{ background:var(--kim-border); }

    .pill{
      border-radius:10px;
      padding:6px 7px;
      margin-bottom:4px;
      border:1px solid;
      font-size:11px;
      line-height:1.3;
      cursor:pointer;
      transition:background 0.15s ease, transform 0.05s ease;
    }

    .pill:hover{
      background-color:rgba(148,163,184,0.16);
      transform:translateY(-1px);
    }

    .pill .title{
      font-weight:500;
      display:block;
    }

    .pill .meta{
      font-size:10px;
      opacity:0.8;
    }

    .pill.alon{
      background:var(--alon-bg);
      border-color:var(--alon-border);
      color:var(--alon-text);
    }
    .pill.kim{
      background:var(--kim-bg);
      border-color:var(--kim-border);
      color:var(--kim-text);
    }
    .pill.fam{
      background:var(--fam-bg);
      border-color:var(--fam-border);
      color:var(--fam-text);
    }
    .pill.other{
      background:var(--other-bg);
      border-color:var(--other-border);
      color:var(--other-text);
    }

    .pill.spanAll{
      grid-column:1 / span 2;
    }

    /* ×›×¤×ª×•×¨ + ×‘×œ×‘×“ */
    .add{
      width:100%;
      padding:4px 0;
      border-radius:8px;
      border:1px dashed rgba(75,85,99,0.8);
      background:transparent;
      color:var(--text-muted);
      font-size:14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .add span.plus{
      font-size:16px;
      line-height:1;
    }
    .add:hover{
      border-style:solid;
      border-color:var(--accent);
      color:var(--accent);
      background:rgba(15,23,42,0.7);
    }

    /* ××™ ×œ×•×§×—/××•×¡×£ */
    .role-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-bottom:2px;
      font-size:10px;
      color:var(--text-muted);
    }

    .seg{
      display:inline-flex;
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.8);
      overflow:hidden;
      background:rgba(15,23,42,0.9);
    }

    .seg button{
      padding:3px 8px;
      border:none;
      background:transparent;
      color:var(--text-muted);
      font-size:10px;
      cursor:pointer;
    }

    .seg button.active{
      color:#020617;
      background:var(--accent);
    }

    .seg button.active.alon{ background:var(--alon-border); color:#0b1120; }
    .seg button.active.kim { background:var(--kim-border); color:#020617; }
    .seg button.active.other{ background:var(--other-border); color:#020617; }

    /* FOOTER ×§×˜×Ÿ */
    .footer{
      margin-top:10px;
      font-size:11px;
      color:var(--text-muted);
      text-align:center;
    }

    dialog{
      border:none;
      border-radius:14px;
      padding:0;
      background:#020617;
      color:var(--text-main);
      box-shadow:0 18px 45px rgba(0,0,0,0.6);
    }

    .dlg{
      padding:14px 14px 10px;
      min-width:260px;
    }

    .dlg h3{
      margin:0 0 10px;
      font-size:15px;
    }

    .field{
      display:grid;
      gap:4px;
      margin-bottom:8px;
      font-size:12px;
    }

    .field label{
      color:var(--text-muted);
      font-size:11px;
    }

    input, select, textarea{
      font:inherit;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text-main);
    }
    textarea{ resize:vertical; }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px;
    }

    .btns{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    @media (max-width:900px){
      .grid{
        grid-template-columns:80px repeat(7,minmax(120px,1fr));
      }
      .wrap{
        padding-inline:8px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      WEEKLY PLANNER FOR COUPLES
      <span class="mark">Kimka</span>
    </h1>

    <p class="subtitle">have a good week ğŸ’›</p>

    <div class="topbar">
      <div class="legend">
        <span class="badge"><span class="dot alon"></span>××œ×•×Ÿ</span>
        <span class="badge"><span class="dot kim"></span>×§×™×</span>
        <span class="badge"><span class="dot fam"></span>××©×¤×—×”</span>
        <span class="badge"><span class="dot other"></span>××—×¨ / ×¡×‘×ª×</span>
      </div>
      <button class="admin-toggle" id="adminToggle">
        âš™ Admin
      </button>
    </div>

    <div class="admin-panel" id="adminPanel">
      ×¤×¢×•×œ×•×ª × ×™×”×•×œ (×‘×©×‘×™×œ×š ×‘×œ×‘×“, ×§×™× ×œ× ×—×™×™×‘×ª ×œ×’×¢×ª ×‘×–×”):
      <div class="admin-grid">
        <button class="btn danger" id="resetWeek">××™×¤×•×¡ ×©×‘×•×¢</button>
        <button class="btn" id="export">×™×™×¦×•× JSON</button>
        <label class="btn">
          ×™×™×‘×•× JSON
          <input id="importFile" type="file" accept="application/json" style="display:none">
        </label>
      </div>
    </div>

    <div id="grid" class="grid"></div>

    <div class="footer">
      ×‘×—×™×¨×ª ×œ×•×§×—/×ª ×•××•×¡×£/×ª ××¡×•× ×›×¨× ×ª ×‘×–××Ÿ ×××ª ×‘×™×Ÿ ×”××›×©×™×¨×™× (Firebase).<br>
      ×¢×¨×™×›×” ××ª×‘×¦×¢×ª ×¢×œ ×™×“×™ ×œ×—×™×¦×” ×¢×œ ×”××©×‘×¦×•×ª ××• ×”××™×¨×•×¢×™×.
    </div>
  </div>

  <!-- ×“×™××œ×•×’ ×¢×¨×™×›×” -->
  <dialog id="dlg">
    <form method="dialog" class="dlg">
      <h3>×¢×¨×™×›×ª ×¤×¨×™×˜</h3>
      <div class="field">
        <label>×›×•×ª×¨×ª</label>
        <input id="title">
      </div>
      <div class="row">
        <div class="field">
          <label>×™×•×</label>
          <select id="day"></select>
        </div>
        <div class="field">
          <label>×—×œ×§ ×‘×™×•×</label>
          <select id="slot">
            <option value="0">×‘×•×§×¨</option>
            <option value="1">××”×œ×š ×”×™×•×</option>
            <option value="2">××—×”×´×¦</option>
            <option value="3">×¢×¨×‘</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>×©×™×™×š ×œ</label>
        <select id="person">
          <option>××œ×•×Ÿ</option>
          <option>×§×™×</option>
          <option>××©×¤×—×”</option>
          <option>××—×¨</option>
        </select>
      </div>
      <div class="field">
        <label>×”×¢×¨×•×ª</label>
        <textarea id="notes" rows="3"></textarea>
      </div>
      <div class="btns">
        <button type="button" class="btn danger" id="deleteBtn">××—×™×§×”</button>
        <button type="button" class="btn" value="cancel" id="cancelBtn">×‘×™×˜×•×œ</button>
        <button type="button" class="btn" id="saveBtn">×©××™×¨×”</button>
      </div>
    </form>
  </dialog>

  <!-- Firebase (compat) + config -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <!-- ×‘×§×•×‘×¥ ×–×” ××ª×” ×©×•××¨ ××ª FIREBASE_CFG ×•-HOUSEHOLD_ID ×›××• ×©×›×‘×¨ ×™×© ×œ×š -->
  <script src="config.js"></script>

  <script>
    const DAYS = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
    const SLOTS = ["×‘×•×§×¨","××”×œ×š ×”×™×•×","××—×”×´×¦","×¢×¨×‘"];

    const LS_KEY = "weekly-planner-sync-local";

    let state = loadLocal() || {
      dropoff: Array(7).fill(null),
      pickup: Array(7).fill(null),
      events: []
    };
    let events = state.events || [];

    let saveTimer = null;
    let applyingRemote = false;

    let db = null;
    let docRef = null;
    let unsub = null;
    let householdId = window.HOUSEHOLD_ID || "alon-kim";

    const grid = document.getElementById('grid');
    const dlg = document.getElementById('dlg');
    const titleEl = document.getElementById('title');
    const dayEl = document.getElementById('day');
    const slotEl = document.getElementById('slot');
    const personEl = document.getElementById('person');
    const notesEl = document.getElementById('notes');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const exportBtn = document.getElementById('export');
    const importFile = document.getElementById('importFile');
    const resetWeekBtn = document.getElementById('resetWeek');
    const adminToggle = document.getElementById('adminToggle');
    const adminPanel = document.getElementById('adminPanel');

    adminToggle.addEventListener('click', () => {
      const open = adminPanel.style.display === 'block';
      adminPanel.style.display = open ? 'none' : 'block';
    });

    function loadLocal(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }
    function saveLocal(){
      localStorage.setItem(LS_KEY, JSON.stringify({ ...state, events }));
    }

    function pillClass(person){
      switch(person){
        case "××œ×•×Ÿ": return "alon";
        case "×§×™×": return "kim";
        case "××©×¤×—×”": return "fam";
        default: return "other";
      }
    }

    function cleanupWeekendSpecials(){
      events = events.filter(e => {
        const isWeekend = e.day >= 5;
        const isSpecial = (e.slot === 0 || e.slot === 2) &&
                         (e.title.startsWith("×œ×•×§×—") || e.title.startsWith("××•×¡×£"));
        return !(isWeekend && isSpecial);
      });
      state.dropoff[5] = state.dropoff[6] = null;
      state.pickup[5]  = state.pickup[6]  = null;
      state.events = events;
    }

    function renderDaysSelect(){
      dayEl.innerHTML = DAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join("");
    }
    renderDaysSelect();

    function render(){
      cleanupWeekendSpecials();
      grid.innerHTML = "";

      // ×©×•×¨×ª ×›×•×ª×¨×•×ª
      grid.append(headCell(""));
      for(let d=0; d<7; d++){
        const h = document.createElement('div');
        h.className = "head";
        const dayName = DAYS[d];
        h.innerHTML = `<span class="day-label">${dayName}</span>`;
        grid.append(h);
      }

      // ×©×•×¨×•×ª ×–××Ÿ
      for(let s=0; s<SLOTS.length; s++){
        grid.append(rowHead(SLOTS[s]));
        for(let d=0; d<7; d++){
          const items = events.filter(e => e.day === d && e.slot === s);
          grid.append(cell(d,s,items));
        }
      }
    }

    function headCell(txt){
      const div = document.createElement('div');
      div.className = "head";
      div.textContent = txt || "";
      return div;
    }

    function rowHead(txt){
      const div = document.createElement('div');
      div.className = "rowhead";
      div.textContent = txt;
      return div;
    }

    function makeExclusiveSeg(current, onChange){
      const seg = document.createElement('div');
      seg.className = "seg";
      const options = ["××œ×•×Ÿ","×§×™×","×¡×‘×ª×"];

      const btns = options.map(name => {
        const b = document.createElement('button');
        b.type = "button";
        b.textContent = name;
        seg.appendChild(b);
        return b;
      });

      function paint(val){
        btns.forEach((b,i)=>{
          const who = options[i];
          b.className = "";
          if(val === who){
            let cls = "active ";
            cls += who === "××œ×•×Ÿ" ? "alon" : (who === "×§×™×" ? "kim" : "other");
            b.className = cls;
          }
        });
      }

      btns.forEach((b,i)=>{
        b.addEventListener('click', ()=>{
          const who = options[i];
          const next = (current === who) ? null : who;
          current = next;
          paint(current);
          onChange(current);
        });
      });

      paint(current);
      return seg;
    }

    function upsertSpecialEvent(day, slot, label, who){
      events = events.filter(e => !(e.day === day && e.slot === slot &&
             (e.title.startsWith("×œ×•×§×—") || e.title.startsWith("××•×¡×£"))));
      if(who){
        const person = (who === "×¡×‘×ª×") ? "××—×¨" : who;
        events.push({
          id: id(),
          day,
          slot,
          title: label,
          person,
          notes:""
        });
      }
      state.events = events;
      scheduleSave();
    }

    function cell(day, slot, items){
      const outer = document.createElement('div');
      outer.className = "cell";
      const inner = document.createElement('div');
      inner.className = "cell-inner";
      outer.appendChild(inner);

      if((slot === 0 || slot === 2) && day < 5){
        const role = document.createElement('div');
        role.className = "role-row";
        const label = document.createElement('span');
        label.textContent = (slot === 0) ? "×œ×•×§×—/×ª ×œ×’×Ÿ:" : "××•×¡×£/×ª:";
        const seg = makeExclusiveSeg(
          slot === 0 ? state.dropoff[day] : state.pickup[day],
          (val)=>{
            if(slot === 0){
              state.dropoff[day] = val;
              upsertSpecialEvent(day,0,"×œ×•×§×—/×ª ×œ×’×Ÿ", val);
            }else{
              state.pickup[day] = val;
              upsertSpecialEvent(day,2,"××•×¡×£/×ª", val);
            }
            render();
          }
        );
        role.append(label, seg);
        inner.appendChild(role);
      }

      const dual = document.createElement('div');
      dual.className = "dual";

      const colA = document.createElement('div');
      colA.className = "col";
      const colK = document.createElement('div');
      colK.className = "col";

      colA.appendChild(colLabel("××œ×•×Ÿ","alon"));
      colK.appendChild(colLabel("×§×™×","kim"));

      // shared (××©×¤×—×” / ××—×¨) â€“ spanning
      items.filter(i => i.person === "××©×¤×—×”" || i.person === "××—×¨")
           .forEach(item => {
        const p = pillNode(item);
        p.classList.add("spanAll");
        dual.appendChild(p);
      });

      items.filter(i => i.person === "××œ×•×Ÿ").forEach(item=>{
        colA.appendChild(pillNode(item));
      });
      items.filter(i => i.person === "×§×™×").forEach(item=>{
        colK.appendChild(pillNode(item));
      });

      colA.appendChild(addBtn(()=> openEditor({
        id:null, day, slot, title:"", person:"××œ×•×Ÿ", notes:""
      })));
      colK.appendChild(addBtn(()=> openEditor({
        id:null, day, slot, title:"", person:"×§×™×", notes:""
      })));

      dual.append(colA,colK);
      inner.appendChild(dual);

      return outer;
    }

    function colLabel(name, cls){
      const d = document.createElement('div');
      d.className = "col-label";
      const dot = document.createElement('span');
      dot.className = "mini-dot " + cls;
      d.append(dot, document.createTextNode(name));
      return d;
    }

    function pillNode(item){
      const p = document.createElement('div');
      p.className = "pill " + pillClass(item.person);
      p.innerHTML =
        `<span class="title">${item.title}</span>` +
        `<span class="meta">${item.person}${item.notes ? " â€¢ " + item.notes : ""}</span>`;
      p.addEventListener('click', ()=> openEditor(item));
      return p;
    }

    function addBtn(onClick){
      const btn = document.createElement('button');
      btn.type = "button";
      btn.className = "add";
      btn.innerHTML = `<span class="plus">+</span>`;
      btn.addEventListener('click', onClick);
      return btn;
    }

    // ===== ×“×™××œ×•×’ =====
    let editingId = null;

    function openEditor(item){
      editingId = item.id;
      titleEl.value = item.title || "";
      dayEl.value = item.day;
      slotEl.value = item.slot;
      personEl.value = item.person || "××œ×•×Ÿ";
      notesEl.value = item.notes || "";
      deleteBtn.style.display = editingId ? "inline-block" : "none";
      dlg.showModal();
    }

    saveBtn.addEventListener('click', ()=>{
      const obj = {
        id: editingId || id(),
        title: titleEl.value.trim(),
        day: Number(dayEl.value),
        slot: Number(slotEl.value),
        person: personEl.value,
        notes: notesEl.value.trim()
      };
      if(!obj.title){
        dlg.close();
        return;
      }
      const idx = events.findIndex(e => e.id === obj.id);
      if(idx >= 0) events[idx] = obj; else events.push(obj);
      state.events = events;
      scheduleSave();
      render();
      dlg.close();
    });

    deleteBtn.addEventListener('click', ()=>{
      if(!editingId) return;
      events = events.filter(e => e.id !== editingId);
      state.events = events;
      scheduleSave();
      render();
      dlg.close();
    });

    cancelBtn.addEventListener('click', ()=>{
      dlg.close();
    });

    // ===== ×™×™×¦×•× / ×™×™×‘×•× / ××™×¤×•×¡ =====
    exportBtn.addEventListener('click', ()=>{
      const blob = new Blob(
        [JSON.stringify({ ...state, events }, null, 2)],
        { type: "application/json" }
      );
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "weekly-plan.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    importFile.addEventListener('change', e=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          state = data;
          events = data.events || [];
          saveLocal();
          scheduleSave();
          render();
        }catch(err){
          alert("×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ");
        }
      };
      reader.readAsText(file);
    });

    resetWeekBtn.addEventListener('click', ()=>{
      if(!confirm("×œ××¤×¡ ××ª ×›×œ ×”×©×‘×•×¢?")) return;
      state.dropoff = Array(7).fill(null);
      state.pickup  = Array(7).fill(null);
      events = [];
      state.events = events;
      scheduleSave();
      render();
    });

    // ===== UTIL =====
    function id(){ return Math.random().toString(36).slice(2,9); }

    // ===== FIREBASE =====
    function initFirebase(){
      try{
        const cfg = window.FIREBASE_CFG;
        if(!cfg || !cfg.apiKey){
          render();
          return;
        }
        const app = firebase.initializeApp(cfg);
        db = firebase.firestore();
        const auth = firebase.auth();
        auth.signInAnonymously()
          .then(()=> initRealtime())
          .catch(err => {
            console.error("auth error", err);
            render();
          });
      }catch(e){
        console.error("firebase init error", e);
        render();
      }
    }

    function initRealtime(){
      if(!db) return render();
      if(unsub) unsub();

      docRef = db.collection("plans").doc(householdId);
      docRef.get().then(snap=>{
        if(!snap.exists){
          docRef.set({
            dropoff: state.dropoff,
            pickup: state.pickup,
            events: events,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      });

      unsub = docRef.onSnapshot(doc=>{
        if(!doc.exists) return;
        applyingRemote = true;
        const data = doc.data();
        state = {
          dropoff: data.dropoff || Array(7).fill(null),
          pickup: data.pickup || Array(7).fill(null),
          events: data.events || []
        };
        events = state.events;
        saveLocal();
        render();
        applyingRemote = false;
      });
    }

    function scheduleSave(){
      saveLocal();
      if(!db || !docRef || applyingRemote) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        docRef.set({
          dropoff: state.dropoff,
          pickup: state.pickup,
          events: state.events || [],
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }, 250);
    }

    // ×”×ª×—×œ×”
    render();
    initFirebase();
  </script>
</body>
</html>
