<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>WEEKLY PLANNER FOR COUPLES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      /* ×¦×‘×¢×™ ×‘×¢×œ×™× */
      --alon-bg: rgba(253, 224, 71, 0.18);
      --alon-text:#b45309;
      --alon-border:#facc15;

      --kim-bg: rgba(129, 140, 248, 0.18);
      --kim-text:#3730a3;
      --kim-border:#818cf8;

      --fam-bg: rgba(45, 212, 191, 0.18);
      --fam-text:#047857;
      --fam-border:#5eead4;

      --other-bg: rgba(148, 163, 184, 0.18);
      --other-text:#111827;
      --other-border:#94a3b8;

      --grid-border:#d1d5db;
      --bg-main:#f3f4f6;
      --bg-header:#eef2ff;
      --text-main:#111827;
      --text-muted:#6b7280;
      --accent:#2563eb;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(circle at top left, #e0f2fe 0, transparent 45%),
                  radial-gradient(circle at top right, #e0e7ff 0, transparent 45%),
                  var(--bg-main);
      color:var(--text-main);
    }

    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:16px;
    }

    header{
      background:linear-gradient(135deg,#eff6ff,#e0f2fe);
      border-radius:18px;
      padding:14px 16px 12px;
      margin-bottom:12px;
      box-shadow:0 12px 30px rgba(15,23,42,0.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .title-block{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    h1{
      margin:0;
      font-size:18px;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }

    .subtitle{
      margin:0;
      color:var(--text-muted);
      font-size:12px;
    }

    .legend{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      font-size:11px;
      align-items:center;
      justify-content:flex-end;
    }

    .badge{ display:inline-flex; align-items:center; gap:6px; }
    .dot{ width:11px; height:11px; border-radius:999px; display:inline-block; }

    .toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:10px 0 8px;
      gap:8px;
      flex-wrap:wrap;
    }

    .toolbar-left{
      font-size:11px;
      color:var(--text-muted);
      display:flex;
      gap:8px;
      align-items:center;
    }

    .toolbar-right{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:white;
      font-size:11px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:white;
    }

    .btn.ghost{
      background:transparent;
    }

    .btn span.icon{
      font-size:13px;
      position:relative;
      top:-1px;
    }

    .sync-indicator{
      font-size:11px;
      color:var(--text-muted);
    }

    .sync-indicator.ok{ color:#16a34a; }
    .sync-indicator.err{ color:#dc2626; }

    .grid-shell{
      background:rgba(15,23,42,0.02);
      border-radius:18px;
      padding:10px;
      box-shadow:0 18px 40px rgba(15,23,42,0.18);
      position:relative;
    }

    .scroll-hint{
      position:absolute;
      inset-inline-end:6px;
      top:0;
      bottom:0;
      width:26px;
      pointer-events:none;
      background:linear-gradient(to left, rgba(15,23,42,0.12), transparent);
      border-radius:18px;
      display:none;
    }

    .grid-wrap{
      overflow-x:auto;
      padding-bottom:4px;
    }

    .grid{
      display:grid;
      min-width:720px;
      grid-template-columns:100px repeat(7, minmax(110px,1fr));
      background:white;
      border-radius:14px;
      border:1px solid #e5e7eb;
    }

    .head{
      position:sticky;
      top:0;
      background:#f9fafb;
      z-index:2;
      padding:8px 6px;
      border-bottom:1px solid #e5e7eb;
      font-size:11px;
      font-weight:600;
      text-align:center;
    }

    .rowhead{
      position:sticky;
      right:0;
      background:#f9fafb;
      z-index:1;
      border-inline-end:1px solid #e5e7eb;
      padding:10px 8px;
      font-size:11px;
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }

    .rowhead small{ color:var(--text-muted); font-weight:400; font-size:10px; }

    .cell{
      min-height:120px;
      padding:6px 6px 8px;
      border-bottom:1px solid #f3f4f6;
      border-inline-start:1px solid var(--grid-border);
      position:relative;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .role{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      font-size:10px;
      color:var(--text-muted);
      padding:3px 4px;
      background:#f9fafb;
      border-radius:8px;
      border:1px dashed #e5e7eb;
    }

    .seg{
      display:inline-flex;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #e5e7eb;
      background:white;
    }

    .seg button{
      border:none;
      background:transparent;
      padding:3px 7px;
      font-size:10px;
      cursor:pointer;
      min-width:36px;
    }

    .seg button.active.alon{ background:var(--alon-bg); color:var(--alon-text); }
    .seg button.active.kim{ background:var(--kim-bg); color:var(--kim-text); }
    .seg button.active.other{ background:var(--other-bg); color:var(--other-text); }

    .events{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:2px;
    }

    .pill{
      border-radius:10px;
      padding:4px 6px;
      font-size:11px;
      border:1px solid;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      cursor:pointer;
    }

    .pill-main{
      display:flex;
      flex-direction:column;
      gap:1px;
    }

    .pill-title{ font-weight:500; }
    .pill-meta{ font-size:10px; opacity:0.75; }

    .pill.alon{ background:var(--alon-bg); color:var(--alon-text); border-color:var(--alon-border); }
    .pill.kim{ background:var(--kim-bg); color:var(--kim-text); border-color:var(--kim-border); }
    .pill.fam{ background:var(--fam-bg); color:var(--fam-text); border-color:var(--fam-border); }
    .pill.other{ background:var(--other-bg); color:var(--other-text); border-color:var(--other-border); }

    .cell-add{
      position:absolute;
      inset-inline-end:4px;
      bottom:4px;
    }

    .btn-add{
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      line-height:1;
      cursor:pointer;
      box-shadow:0 2px 4px rgba(15,23,42,0.15);
    }

    .btn-add:hover{ background:#eff6ff; }

    /* ×“×™××œ×•×’ ×¢×¨×™×›×” */
    dialog{
      border:none;
      border-radius:16px;
      padding:0;
      max-width:360px;
      width:100%;
      box-shadow:0 18px 40px rgba(15,23,42,0.35);
    }

    .dlg{
      padding:14px 14px 10px;
    }

    .dlg h2{
      margin:0 0 8px;
      font-size:16px;
    }

    .field{ margin-bottom:8px; font-size:12px; }
    .field label{ display:block; margin-bottom:3px; color:var(--text-muted); }
    .field input,
    .field select,
    .field textarea{
      width:100%;
      font:inherit;
      padding:6px 7px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      outline:none;
    }

    .field textarea{ resize:vertical; min-height:52px; }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px;
    }

    .btns{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:8px;
      gap:6px;
    }

    .btn-group-right{ display:flex; gap:6px; }

    .btn.danger{
      border-color:#fecaca;
      background:#fef2f2;
      color:#b91c1c;
    }

    .btn.gcal{
      border-color:#e5e7eb;
      background:#f9fafb;
      font-size:10px;
    }

    .footer{
      margin-top:6px;
      font-size:11px;
      color:var(--text-muted);
      text-align:center;
    }

    @media (max-width:768px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      .legend{ justify-content:flex-start; }
      .grid-shell{ padding:8px; }
      .grid{ min-width:640px; }
      .scroll-hint{ display:block; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title-block">
        <h1>WEEKLY PLANNER FOR COUPLES</h1>
        <p class="subtitle">have a good week Â· ×—×œ×•×§×” ×©×‘×•×¢×™×ª ×©×œ ×‘×•×§×¨ / ×™×•× / ××—×¨ ×”×¦×”×¨×™×™× / ×¢×¨×‘.</p>
      </div>
      <div class="legend">
        <span class="badge"><span class="dot" style="background:var(--alon-bg)"></span>××œ×•×Ÿ</span>
        <span class="badge"><span class="dot" style="background:var(--kim-bg)"></span>×§×™×</span>
        <span class="badge"><span class="dot" style="background:var(--fam-bg)"></span>××©×¤×—×”</span>
        <span class="badge"><span class="dot" style="background:var(--other-bg)"></span>××—×¨ / ×¡×‘×ª×</span>
      </div>
    </header>

    <div class="toolbar">
      <div class="toolbar-left">
        <span id="syncStatus" class="sync-indicator">Local only</span>
      </div>
      <div class="toolbar-right">
        <button id="btnExportIcs" class="btn ghost" type="button">
          <span class="icon">ğŸ“†</span>
          Export week to Google Calendar (.ics)
        </button>
        <button id="btnReset" class="btn" type="button">
          <span class="icon">â†º</span>
          Reset week
        </button>
      </div>
    </div>

    <div class="grid-shell">
      <div class="scroll-hint"></div>
      <div class="grid-wrap">
        <div id="grid" class="grid"></div>
      </div>
    </div>

    <p class="footer">
      ×‘×‘×•×§×¨: ××™ ×œ×•×§×— ×œ×’×Ÿ (××³â€“×”×³). ××—×”"×¦: ××™ ××•×¡×£ (××³â€“×”×³). ×‘×›×œ ××©×‘×¦×ª ××¤×©×¨ ×œ×”×•×¡×™×£ ×›××” ××©×™××•×ª ×©×¨×•×¦×™×, ××‘×œ ×¨×§ ×¤×œ×•×¡ ××—×“ ×œ×¤×ª×™×—×”.
    </p>
  </div>

  <dialog id="dlg">
    <form method="dialog" class="dlg">
      <h2>×¢×¨×™×›×ª ×¤×¨×™×˜</h2>

      <div class="field">
        <label>×›×•×ª×¨×ª</label>
        <input id="fTitle" />
      </div>

      <div class="row">
        <div class="field">
          <label>×™×•×</label>
          <select id="fDay"></select>
        </div>
        <div class="field">
          <label>×—×œ×§ ×‘×™×•×</label>
          <select id="fSlot">
            <option value="0">×‘×•×§×¨</option>
            <option value="1">×™×•×</option>
            <option value="2">××—×”"×¦</option>
            <option value="3">×¢×¨×‘</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>×©×™×™×š ×œ</label>
        <select id="fPerson">
          <option>××œ×•×Ÿ</option>
          <option>×§×™×</option>
          <option>××©×¤×—×”</option>
          <option>××—×¨</option>
        </select>
      </div>

      <div class="field">
        <label>×”×¢×¨×•×ª (×œ× ×—×•×‘×”)</label>
        <textarea id="fNotes"></textarea>
      </div>

      <div class="btns">
        <button id="btnDelete" class="btn danger" type="button">Delete</button>
        <div class="btn-group-right">
          <button id="btnGcal" class="btn gcal" type="button">
            <span class="icon">âœ</span> Add this to Google Calendar
          </button>
          <button class="btn" value="cancel">Cancel</button>
          <button id="btnSave" class="btn primary" type="button">Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <!-- config.js ×¦×¨×™×š ×œ×”×›×™×œ window.FIREBASE_CFG + window.HOUSEHOLD_ID -->
  <script src="config.js"></script>

  <script>
    const DAYS = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
    const SLOTS = ["×‘×•×§×¨","×™×•×","××—×”\"×¦","×¢×¨×‘"];
    const LS_KEY = "weekly-planner-state-v2";

    let state = loadLocal() || {
      dropoff: Array(7).fill(null),
      pickup:  Array(7).fill(null),
      events:  []
    };
    let events = state.events;

    // Firebase
    let db = null;
    let docRef = null;
    let unsub = null;
    let saveTimer = null;
    let applyingRemote = false;
    let householdId = window.HOUSEHOLD_ID || "alon-kim";

    const gridEl       = document.getElementById("grid");
    const syncStatusEl = document.getElementById("syncStatus");
    const btnReset     = document.getElementById("btnReset");
    const btnExportIcs = document.getElementById("btnExportIcs");

    const dlg      = document.getElementById("dlg");
    const fTitle   = document.getElementById("fTitle");
    const fDay     = document.getElementById("fDay");
    const fSlot    = document.getElementById("fSlot");
    const fPerson  = document.getElementById("fPerson");
    const fNotes   = document.getElementById("fNotes");
    const btnSave  = document.getElementById("btnSave");
    const btnDel   = document.getElementById("btnDelete");
    const btnGcal  = document.getElementById("btnGcal");

    let editingId = null;

    function id(){ return Math.random().toString(36).slice(2,9); }

    function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify({ ...state, events })); }

    function loadLocal(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)); }
      catch(e){ return null; }
    }

    function pillClass(person){
      if(person === "××œ×•×Ÿ") return "alon";
      if(person === "×§×™×") return "kim";
      if(person === "××©×¤×—×”") return "fam";
      return "other";
    }

    function makeDayOptions(){
      fDay.innerHTML = DAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join("");
    }
    makeDayOptions();

    function cleanupWeekendSpecials(){
      events = events.filter(e => {
        const isWeekend = e.day >= 5;
        const isSpecial = (e.slot === 0 || e.slot === 2) && (e.title.startsWith("×œ×•×§×—") || e.title.startsWith("××•×¡×£"));
        return !(isWeekend && isSpecial);
      });
      state.dropoff[5] = state.dropoff[6] = null;
      state.pickup[5]  = state.pickup[6]  = null;
      state.events = events;
    }

    function render(){
      cleanupWeekendSpecials();

      gridEl.innerHTML = "";
      gridEl.append(makeHeadCell(""));
      for(let d=0; d<7; d++){
        gridEl.append(makeHeadCell(DAYS[d]));
      }

      for(let s=0; s<4; s++){
        gridEl.append(makeRowHead(s));
        for(let d=0; d<7; d++){
          const items = events.filter(e => e.day === d && e.slot === s);
          gridEl.append(makeCell(d, s, items));
        }
      }
    }

    function makeHeadCell(text){
      const div = document.createElement("div");
      div.className = "head";
      div.textContent = text;
      return div;
    }

    function makeRowHead(slot){
      const div = document.createElement("div");
      div.className = "rowhead";
      const label = document.createElement("span");
      label.textContent = SLOTS[slot];
      const sm = document.createElement("small");
      if(slot === 0) sm.textContent = "07:00";
      else if(slot === 1) sm.textContent = "10:00";
      else if(slot === 2) sm.textContent = "16:00";
      else sm.textContent = "20:00";
      div.append(label, sm);
      return div;
    }

    function makeExclusiveSeg(current, onChange){
      const seg = document.createElement("div");
      seg.className = "seg";
      const options = ["××œ×•×Ÿ","×§×™×","×¡×‘×ª×"];
      const btns = options.map(name => {
        const b = document.createElement("button");
        b.type = "button";
        b.textContent = name;
        seg.append(b);
        return b;
      });
      function paint(val){
        btns.forEach((b,i)=>{
          const who = options[i];
          b.className = (val === who)
            ? `active ${who === "××œ×•×Ÿ" ? "alon" : (who === "×§×™×" ? "kim" : "other")}`
            : "";
        });
      }
      btns.forEach((b,i)=>{
        b.addEventListener("click", ()=>{
          const who = options[i];
          const next = (current === who) ? null : who;
          current = next;
          paint(current);
          onChange(current);
        });
      });
      paint(current);
      return seg;
    }

    function upsertSpecialEvent(day, slot, label, who){
      events = events.filter(e => !(e.day === day && e.slot === slot && (e.title.startsWith("×œ×•×§×—") || e.title.startsWith("××•×¡×£")) ));
      if(who){
        const person = (who === "×¡×‘×ª×") ? "××—×¨" : who;
        events.push({ id:id(), day, slot, title:label, person, notes:"" });
      }
      state.events = events;
      scheduleSave();
    }

    function makeCell(day, slot, items){
      const cell = document.createElement("div");
      cell.className = "cell";

      if((slot === 0 || slot === 2) && day < 5){
        const role = document.createElement("div");
        role.className = "role";
        const label = document.createElement("span");
        label.textContent = slot === 0 ? "×œ×•×§×—/×ª ×œ×’×Ÿ" : "××•×¡×£/×ª";
        const current = slot === 0 ? state.dropoff[day] : state.pickup[day];
        const seg = makeExclusiveSeg(current, (val)=>{
          if(slot === 0){
            state.dropoff[day] = val;
            upsertSpecialEvent(day, 0, "×œ×•×§×—/×ª ×œ×’×Ÿ", val);
          } else {
            state.pickup[day] = val;
            upsertSpecialEvent(day, 2, "××•×¡×£/×ª", val);
          }
          render();
        });
        role.append(label, seg);
        cell.append(role);
      }

      const evWrap = document.createElement("div");
      evWrap.className = "events";

      items.forEach(item => {
        evWrap.append(makePill(item));
      });

      cell.append(evWrap);

      const addWrap = document.createElement("div");
      addWrap.className = "cell-add";
      const addBtn = document.createElement("button");
      addBtn.type = "button";
      addBtn.className = "btn-add";
      addBtn.textContent = "+";
      addBtn.addEventListener("click", ()=>{
        openEditor({ id:null, day, slot, title:"", person:"××œ×•×Ÿ", notes:"" });
      });
      addWrap.append(addBtn);
      cell.append(addWrap);

      return cell;
    }

    function makePill(item){
      const pill = document.createElement("div");
      pill.className = `pill ${pillClass(item.person)}`;

      const main = document.createElement("div");
      main.className = "pill-main";

      const t = document.createElement("div");
      t.className = "pill-title";
      t.textContent = item.title;

      const m = document.createElement("div");
      m.className = "pill-meta";
      m.textContent = `${item.person} â€¢ ${SLOTS[item.slot]} â€¢ ${DAYS[item.day]}`;

      main.append(t);
      if(item.notes){
        const notes = document.createElement("div");
        notes.className = "pill-meta";
        notes.textContent = item.notes;
        main.append(notes);
      }
      main.append(m);

      pill.append(main);
      pill.addEventListener("click", ()=> openEditor(item));
      return pill;
    }

    function openEditor(item){
      editingId = item.id;
      fTitle.value  = item.title || "";
      fDay.value    = item.day;
      fSlot.value   = item.slot;
      fPerson.value = item.person || "××œ×•×Ÿ";
      fNotes.value  = item.notes || "";

      btnDel.style.display = editingId ? "inline-flex" : "none";
      dlg.showModal();
    }

    btnSave.addEventListener("click", ()=>{
      const obj = {
        id: editingId || id(),
        title: (fTitle.value || "").trim(),
        day: Number(fDay.value),
        slot: Number(fSlot.value),
        person: fPerson.value,
        notes: (fNotes.value || "").trim()
      };
      if(!obj.title){ dlg.close(); return; }
      const idx = events.findIndex(e => e.id === obj.id);
      if(idx >= 0) events[idx] = obj; else events.push(obj);
      state.events = events;
      scheduleSave();
      render();
      dlg.close();
    });

    btnDel.addEventListener("click", ()=>{
      if(!editingId){ return; }
      events = events.filter(e => e.id !== editingId);
      state.events = events;
      scheduleSave();
      render();
      dlg.close();
    });

    // Reset all
    btnReset.addEventListener("click", ()=>{
      if(!confirm("×œ××¤×¡ ××ª ×”×©×‘×•×¢?")) return;
      state.dropoff = Array(7).fill(null);
      state.pickup  = Array(7).fill(null);
      events = [];
      state.events = events;
      scheduleSave();
      render();
    });

    // --- Google Calendar sync (ICS export) ---
    function getWeekStart(){
      const now = new Date();
      const day = now.getDay(); // 0=Sunday
      const start = new Date(now);
      start.setHours(0,0,0,0);
      start.setDate(now.getDate() - day); // beginning of this week (Sunday)
      return start;
    }

    function formatICSDate(dt){
      const pad = n => String(n).padStart(2,"0");
      return (
        dt.getFullYear().toString() +
        pad(dt.getMonth()+1) +
        pad(dt.getDate()) +
        "T" +
        pad(dt.getHours()) +
        pad(dt.getMinutes()) +
        pad(dt.getSeconds())
      );
    }

    function buildICSEvents(){
      const lines = [];
      const weekStart = getWeekStart();

      const slotTime = slot => {
        const d = new Date(weekStart);
        return d;
      };

      function makeDateFor(day, slot){
        const d = new Date(weekStart);
        d.setDate(d.getDate() + day);
        if(slot === 0) d.setHours(7,0,0,0);
        else if(slot === 1) d.setHours(10,0,0,0);
        else if(slot === 2) d.setHours(16,0,0,0);
        else d.setHours(20,0,0,0);
        return d;
      }

      // Create events from explicit items
      events.forEach(ev => {
        const dtStart = makeDateFor(ev.day, ev.slot);
        const dtEnd   = new Date(dtStart.getTime() + 60*60*1000); // ×©×¢×” ×‘×¨×™×¨×ª ××—×“×œ
        const uid = `wp-${ev.id}@alon-kim`;
        lines.push("BEGIN:VEVENT");
        lines.push("UID:"+uid);
        lines.push("SUMMARY:"+ev.title.replace(/,/g, "\\,"));
        lines.push("DESCRIPTION:"+(ev.notes || "Weekly Planner for Couples"));
        lines.push("DTSTART:"+formatICSDate(dtStart));
        lines.push("DTEND:"+formatICSDate(dtEnd));
        lines.push("END:VEVENT");
      });

      // Dropoff / Pickup shortcuts (if not already represented explicitly)
      state.dropoff.forEach((who, day)=>{
        if(!who || day > 4) return;
        const title = `Drop-off Theo (${who})`;
        const dtStart = makeDateFor(day, 0);
        const dtEnd   = new Date(dtStart.getTime() + 45*60*1000);
        const uid = `wp-drop-${day}@alon-kim`;
        lines.push("BEGIN:VEVENT");
        lines.push("UID:"+uid);
        lines.push("SUMMARY:"+title.replace(/,/g, "\\,"));
        lines.push("DESCRIPTION:Auto from Weekly Planner for Couples");
        lines.push("DTSTART:"+formatICSDate(dtStart));
        lines.push("DTEND:"+formatICSDate(dtEnd));
        lines.push("END:VEVENT");
      });

      state.pickup.forEach((who, day)=>{
        if(!who || day > 4) return;
        const title = `Pick-up Theo (${who})`;
        const dtStart = makeDateFor(day, 2);
        const dtEnd   = new Date(dtStart.getTime() + 45*60*1000);
        const uid = `wp-pick-${day}@alon-kim`;
        lines.push("BEGIN:VEVENT");
        lines.push("UID:"+uid);
        lines.push("SUMMARY:"+title.replace(/,/g, "\\,"));
        lines.push("DESCRIPTION:Auto from Weekly Planner for Couples");
        lines.push("DTSTART:"+formatICSDate(dtStart));
        lines.push("DTEND:"+formatICSDate(dtEnd));
        lines.push("END:VEVENT");
      });

      return lines;
    }

    function exportWeekToICS(){
      const lines = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Alon&Kim//Weekly Planner//EN"
      ];
      lines.push(...buildICSEvents());
      lines.push("END:VCALENDAR");
      const blob = new Blob([lines.join("\r\n")], { type:"text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "weekly-planner.ics";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    btnExportIcs.addEventListener("click", exportWeekToICS);

    // Add current item to Google Calendar via link
    btnGcal.addEventListener("click", ()=>{
      if(!editingId){
        alert("×©××•×¨ ××ª ×”×¤×¨×™×˜ ×•××– ×ª×•×›×œ ×œ×™×™×¦×¨ ××™×¨×•×¢ ×‘×™×•××Ÿ.");
        return;
      }
      const ev = events.find(e => e.id === editingId);
      if(!ev){
        alert("×œ× × ××¦× ×¤×¨×™×˜.");
        return;
      }
      const dtStart = (function(){
        const weekStart = getWeekStart();
        const d = new Date(weekStart);
        d.setDate(d.getDate() + ev.day);
        if(ev.slot === 0) d.setHours(7,0,0,0);
        else if(ev.slot === 1) d.setHours(10,0,0,0);
        else if(ev.slot === 2) d.setHours(16,0,0,0);
        else d.setHours(20,0,0,0);
        return d;
      })();
      const dtEnd = new Date(dtStart.getTime() + 60*60*1000);
      const fmt = d => {
        const pad = n => String(n).padStart(2,"0");
        return (
          d.getFullYear().toString() +
          pad(d.getMonth()+1) +
          pad(d.getDate()) +
          "T" +
          pad(d.getHours()) +
          pad(d.getMinutes()) +
          "00"
        );
      };
      const base = "https://calendar.google.com/calendar/render?action=TEMPLATE";
      const params = new URLSearchParams({
        text: ev.title,
        details: ev.notes || "From Weekly Planner for Couples",
        dates: fmt(dtStart) + "/" + fmt(dtEnd)
      });
      const url = base + "&" + params.toString();
      window.open(url, "_blank");
    });

    // --- Firebase (unchanged, using FIREBASE_CFG & HOUSEHOLD_ID) ---

    function initFirebase(){
      try{
        const cfg = window.FIREBASE_CFG;
        if(!cfg || !cfg.apiKey){
          syncStatusEl.textContent = "Local only";
          render();
          return;
        }
        const app = firebase.initializeApp(cfg);
        const auth = firebase.auth();
        db = firebase.firestore();
        syncStatusEl.textContent = "Connectingâ€¦";
        auth.signInAnonymously()
          .then(()=>{
            syncStatusEl.textContent = "Connected";
            initRealtime();
          })
          .catch(err => {
            console.error(err);
            syncStatusEl.textContent = "Firebase error";
            syncStatusEl.classList.add("err");
            render();
          });
      } catch(err){
        console.error(err);
        syncStatusEl.textContent = "Config error";
        syncStatusEl.classList.add("err");
        render();
      }
    }

    function initRealtime(){
      if(!db){ render(); return; }
      if(unsub) unsub();
      docRef = db.collection("plans").doc(householdId);
      docRef.get().then(snap => {
        if(!snap.exists){
          docRef.set({
            ...state,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      });
      unsub = docRef.onSnapshot(doc => {
        if(!doc.exists) return;
        applyingRemote = true;
        const data = doc.data();
        state = {
          dropoff: data.dropoff || Array(7).fill(null),
          pickup:  data.pickup  || Array(7).fill(null),
          events:  data.events  || []
        };
        events = state.events;
        saveLocal();
        render();
        applyingRemote = false;
        syncStatusEl.textContent = "Synced (" + householdId + ")";
        syncStatusEl.classList.add("ok");
      });
    }

    function scheduleSave(){
      saveLocal();
      if(!db || !docRef || applyingRemote) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        docRef.set({
          ...state,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        syncStatusEl.textContent = "Savingâ€¦";
      }, 250);
    }

    // Start
    render();
    initFirebase();
  </script>
</body>
</html>
